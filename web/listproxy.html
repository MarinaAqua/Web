<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy List Checker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        @keyframes pulse {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
            }
        }

        .pulse {
            animation: pulse 1s infinite; /* Menambahkan efek pulse */
        }
    </style>
</head>

<body class="bg-gray-900 text-white">
    <div class="container mx-auto p-5">
        <h1 class="text-3xl text-center mb-5">Proxy List Checker</h1>
        <div id="proxy-list" class="space-y-4"></div>
        <div class="flex justify-center mt-5">
            <button onclick="prevPage()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-l">
                Prev
            </button>
            <span id="page-numbers" class="mx-2"></span>
            <button onclick="nextPage()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-r">
                Next
            </button>
        </div>
    </div>

    <script>
        const proxyList = [];
        const cache = {}; // Objek untuk menyimpan hasil pemeriksaan
        let currentPage = 1;
        const itemsPerPage = 10;

        async function fetchProxies() {
            const response = await fetch('https://raw.githubusercontent.com/clubgratis/Proxy/refs/heads/main/all.txt');
            const text = await response.text();
            const lines = text.split('\n');
            lines.forEach(line => {
                const [ip, port, country, isp] = line.split(',');
                if (ip && port && country && isp) {
                    proxyList.push({ ip, port, country, isp });
                }
            });
            renderProxies(); // Render proxy terlebih dahulu
            renderPagination();
        }

        async function checkProxy(ip, port) {
            try {
                const response = await fetch(`https://api-checker.aquamarinelavinia.workers.dev/?ip=${ip}:${port}`);
                const result = await response.json();
                return result.message && (result.message.includes('ACTIVE') || result.message.includes('ACTIVO'));
            } catch (error) {
                console.error(`Failed to check proxy ${ip}:${port} - ${error}`);
                return false; // Anggap proxy tidak aktif jika gagal
            }
        }

        async function renderProxies() {
            const proxyDiv = document.getElementById('proxy-list');
            proxyDiv.innerHTML = ''; // Kosongkan sebelumnya

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedProxies = proxyList.slice(start, end);

            // Render proxy dan periksa statusnya dari cache (jika ada)
            for (const proxy of paginatedProxies) {
                const item = document.createElement('div');
                item.className = "bg-gray-800 border border-gray-700 p-4 rounded-lg flex flex-col";

                item.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="font-bold">${proxy.isp}</span>
                            <span class="status bg-gray-500 inline-block w-4 h-4 rounded-full ml-2"></span> <!-- Status Default -->
                        </div>
                    </div>
                    <div class="text-gray-400">
                        Country: ${proxy.country} <br />
                        IP: ${proxy.ip}:${proxy.port}
                    </div>
                    <button onclick="createConnection('${proxy.ip}', '${proxy.port}')" class="mt-2 bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded">
                        Create
                    </button>
                `;
                proxyDiv.appendChild(item);

                // Cek cache untuk status
                const cacheKey = `${proxy.ip}:${proxy.port}`;
                if (cache[cacheKey] !== undefined) {
                    // Status ada di cache, langsung update UI
                    const statusSpan = item.querySelector('.status');
                    const isActive = cache[cacheKey];
                    if (isActive) {
                        statusSpan.className = 'status bg-green-500 pulse inline-block w-4 h-4 rounded-full ml-2'; // Jika aktif
                    } else {
                        statusSpan.className = 'status bg-red-500 inline-block w-4 h-4 rounded-full ml-2'; // Jika tidak aktif
                    }
                } else {
                    // Jika tidak ada di cache, lakukan pemeriksaan
                    checkProxy(proxy.ip, proxy.port).then(isActive => {
                        const statusSpan = item.querySelector('.status');
                        cache[cacheKey] = isActive; // Simpan status ke cache
                        if (isActive) {
                            console.log(`Proxy ${proxy.isp} is ACTIVE`);
                            statusSpan.className = 'status bg-green-500 pulse inline-block w-4 h-4 rounded-full ml-2'; // Jika aktif
                        } else {
                            console.log(`Proxy ${proxy.isp} is DEAD`);
                            statusSpan.className = 'status bg-red-500 inline-block w-4 h-4 rounded-full ml-2'; // Jika tidak aktif
                        }
                    });
                }
            }
        }

        function renderPagination() {
            const pageNumbersDiv = document.getElementById('page-numbers');
            const totalPages = Math.ceil(proxyList.length / itemsPerPage);
            pageNumbersDiv.innerHTML = '';

            if (currentPage > 1) {
                pageNumbersDiv.appendChild(createPageButton(currentPage - 1, 'Prev'));
            }

            let startIndex = Math.max(1, currentPage - 2);
            let endIndex = Math.min(totalPages, startIndex + 4);

            if (startIndex > 1) {
                pageNumbersDiv.appendChild(createPageButton(1, '1'));
                if (startIndex > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'mx-2';
                    ellipsis.textContent = '...';
                    pageNumbersDiv.appendChild(ellipsis);
                }
            }

            for (let i = startIndex; i <= endIndex; i++) {
                pageNumbersDiv.appendChild(createPageButton(i, i));
            }

            if (endIndex < totalPages) {
                if (endIndex < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'mx-2';
                    ellipsis.textContent = '...';
                    pageNumbersDiv.appendChild(ellipsis);
                }
                pageNumbersDiv.appendChild(createPageButton(totalPages, totalPages));
            }

            if (currentPage < totalPages) {
                pageNumbersDiv.appendChild(createPageButton(currentPage + 1, 'Next'));
            }
        }

        function createPageButton(page, text) {
            const button = document.createElement('button');
            button.className = "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded";
            button.textContent = text;
            button.onclick = () => {
                currentPage = page;
                renderProxies(); // Render semua proxy untuk halaman itu
                renderPagination(); // Perbarui pagination
            };
            return button;
        }

        function createConnection(ip, port) {
            alert(`Creating connection for IP: ${ip}, Port: ${port}`);
        }

        // Fetch proxies saat halaman dimuat
        fetchProxies();
    </script>
</body>
</html>
